<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KartTiming - Sistema Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #121212; --bg-panel: #1e1e1e; --primary: #00e676;
            --secondary: #2979ff; --danger: #ff1744; --warning: #ffea00;
            --text-main: #ffffff; --text-muted: #b0b0b0;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 80px; background-color: #000; display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-right: 1px solid #333; transition: width 0.3s; z-index: 10; flex-shrink: 0; }
        .sidebar:hover { width: 220px; }
        .nav-btn { background: none; border: none; color: var(--text-muted); width: 100%; padding: 15px; text-align: left; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; gap: 15px; transition: 0.2s; overflow: hidden; white-space: nowrap; }
        .nav-btn:hover, .nav-btn.active { color: var(--primary); background-color: rgba(0, 230, 118, 0.1); border-left: 3px solid var(--primary); }
        .nav-btn span { font-size: 0.9rem; font-weight: bold; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .tab-content { display: none; padding-bottom: 80px; } 
        .tab-content.active { display: block; }
        .glass-panel { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; position: relative; }
        input, select { background: #2a2a2a; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; flex: 1; font-size: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: #000; } 
        .btn-blue { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; background: #333; padding: 12px 10px; color: var(--primary); }
        td { padding: 10px; border-bottom: 1px solid #333; }
        .driver-tag { display: inline-block; background: #333; padding: 5px 10px; border-radius: 4px; margin: 2px; border: 1px solid var(--primary); font-size: 0.8rem; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #2a2a2a; border: 1px solid var(--primary); z-index: 100; max-height: 200px; overflow-y: auto; border-radius: 0 0 6px 6px; display: none; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; }
        .search-item:hover { background: #333; color: var(--primary); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-panel); margin: 10% auto; padding: 25px; width: 400px; border-radius: 10px; border: 1px solid var(--primary); max-width: 90%; }
        .stat-card { background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); flex: 1; min-width: 140px; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; height: auto; flex-direction: row; padding: 5px; border-right: none; border-bottom: 1px solid #333; overflow-x: auto; } }
    </style>
</head>
<body>

<nav class="sidebar">
    <button class="nav-btn active" onclick="switchTab('clientes')"><span>üë• Clientes</span></button>
    <button class="nav-btn" onclick="switchTab('corridas')"><span>üèéÔ∏è Corridas</span></button>
    <button class="nav-btn" onclick="switchTab('estoque')"><span>üì¶ Estoque (Cad)</span></button>
    <button class="nav-btn" onclick="switchTab('entrada-produtos')"><span>üöõ Entrada Merc.</span></button>
    <button class="nav-btn" onclick="switchTab('venda-avulsa')"><span>üõí Vendas</span></button>
    <button class="nav-btn" onclick="switchTab('gastos')"><span>üí∏ Sa√≠da de Gastos</span></button>
    <button class="nav-btn" onclick="switchTab('relatorios')"><span>üìä Relat√≥rios</span></button>
    <button class="nav-btn" onclick="switchTab('dashboard')"><span>üìà Dash Financeiro</span></button>
</nav>

<div class="main-content">
    
    <div id="tab-clientes" class="tab-content active">
        <h2>Cadastro de Clientes</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="text" id="cliNome" placeholder="Nome Completo">
                <input type="text" id="cliTelefone" placeholder="Telefone">
                <input type="email" id="cliEmail" placeholder="E-mail">
                <button class="btn btn-primary" onclick="salvarCliente()">Salvar Cliente</button>
            </div>
        </div>
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Clientes Cadastrados</h3>
                <input type="text" id="searchTable" placeholder="üîç Pesquisar por nome..." style="max-width:300px;" onkeyup="carregarClientes()">
            </div>
            <div style="overflow-x:auto">
                <table id="tabelaClientes">
                    <thead><tr><th>Nome</th><th>Telefone</th><th>E-mail</th><th>A√ß√£o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-corridas" class="tab-content">
        <h2>Agendar Nova Bateria</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="text" id="raceName" placeholder="Nome da Bateria">
                <div style="flex:1; position:relative;">
                    <input type="text" id="responsible" placeholder="Respons√°vel" onkeyup="searchClient(this, 'res_results')">
                    <div id="res_results" class="search-results"></div>
                </div>
                <input type="date" id="raceDate">
                <input type="time" id="raceTime">
            </div>
            <div class="form-row">
                <select id="raceMode">
                    <option value="corrida">Modo: Corrida</option>
                    <option value="tomada">Modo: Tomada de Tempo</option>
                </select>
                <select id="circuitSelect"><option value="">Carregando pistas...</option></select>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Adicionar Pilotos</h3>
            <div class="form-row">
                <div style="flex:2; position:relative;">
                    <input type="text" id="driverName" placeholder="Nome do Piloto" onkeyup="searchClient(this, 'driver_results')">
                    <div id="driver_results" class="search-results"></div>
                </div>
                <input type="number" id="driverPrice" placeholder="Valor (R$)" step="0.01" style="flex:1;">
                <select id="driverPayment" style="flex:1;">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="D√©bito">D√©bito</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                    <option value="Cortesia">Cortesia</option>
                </select>
                <button class="btn btn-blue" onclick="addDriverToList()">+ Adicionar</button>
            </div>
            <table id="tempDriversTable">
                <thead><tr><th>Piloto</th><th>Pista</th><th>Pagamento</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align:right; font-weight:bold;">TOTAL BATERIA:</td>
                        <td id="totalRaceValue" style="color:var(--primary); font-weight:bold;">R$ 0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="saveBooking()" style="width: 100%;">ENVIAR PARA CRONOMETRAGEM</button>
            </div>
        </div>
        <h3>Baterias Agendadas</h3>
        <div id="bookingList"></div>
    </div>

    <div id="tab-estoque" class="tab-content">
        <h2>Gest√£o de Estoque</h2>
        <div class="glass-panel">
            <h3>Cadastrar Novo Produto</h3>
            <div class="form-row">
                <input type="text" id="novoProdNome" placeholder="Nome do Produto" style="flex: 2;">
                <input type="number" id="novoProdPreco" placeholder="Pre√ßo de Venda" step="0.01">
                <input type="number" id="novoProdMin" placeholder="M√≠nimo" style="flex: 1;">
                <button class="btn btn-primary" onclick="cadastrarProduto()">Criar Produto</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Estoque Atual</h3>
            <table id="tabelaEstoqueGeral">
                <thead><tr><th>Produto</th><th>Pre√ßo</th><th>Qtd</th><th>M√≠n.</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                <tbody id="listaEstoqueGeralBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-entrada-produtos" class="tab-content">
        <h2>Entrada de Mercadoria</h2>
        <div class="glass-panel">
            <div class="form-row">
                <select id="selectEntradaProduto"><option value="">Carregando...</option></select>
                <input type="number" id="entradaQtd" placeholder="Qtd">
                <input type="number" id="entradaCusto" placeholder="Custo Un." step="0.01">
                <select id="entradaPagamento">
                    <option value="Dinheiro">Dinheiro (Caixa)</option>
                    <option value="PIX">PIX</option>
                </select>
                <button class="btn btn-primary" onclick="registrarEntrada()">Registrar</button>
            </div>
        </div>
    </div>

    <div id="tab-venda-avulsa" class="tab-content">
        <h2>Nova Venda R√°pida</h2>
        <div class="glass-panel">
            <div class="form-row">
                <select id="selectProdutoVenda"></select>
                <input type="number" id="qtdProdutoVenda" value="1" min="1">
                <select id="salePayment">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="D√©bito">D√©bito</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                </select>
                <button class="btn btn-primary" onclick="realizarVendaAvulsa()">Finalizar Venda</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>√öltimas Vendas (Hoje)</h3>
            <table id="tabelaVendasAvulsas">
                <thead><tr><th>Data</th><th>Item</th><th>Qtd</th><th>Pagamento</th><th>Total</th><th>A√ß√£o</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-gastos" class="tab-content">
        <h2>Registro de Despesas</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="text" id="gastoDescricao" placeholder="Descri√ß√£o" style="flex: 2;">
                <select id="gastoCategoria" style="flex:1;">
                    <option value="Aluguel">Aluguel</option>
                    <option value="Funcionarios">Funcion√°rios</option>
                    <option value="AguaLuz">Utilidades (√Ågua/Luz)</option>
                    <option value="Manutencao">Manuten√ß√£o</option>
                    <option value="CompraEstoque">Estoque</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="form-row">
                <input type="number" id="gastoValor" placeholder="Valor (R$)" step="0.01">
                <input type="date" id="gastoData">
                <button class="btn btn-danger" onclick="salvarDespesa()">Registrar Sa√≠da</button>
            </div>
        </div>
        <table id="tabelaDespesas">
            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab-relatorios" class="tab-content">
        <h2>Relat√≥rio Financeiro</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="date" id="reportStart">
                <input type="date" id="reportEnd">
                <button class="btn btn-blue" onclick="gerarRelatorio()">üîç Filtrar</button>
            </div>
        </div>
        
        <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;">
            <div class="stat-card">
                <div>TOTAL ENTRADAS</div>
                <div id="statTotal" style="font-size:1.5rem; color:var(--primary)">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>DINHEIRO</div>
                <div id="statDinheiro" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>PIX</div>
                <div id="statPIX" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>D√âBITO</div>
                <div id="statDebito" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>CR√âDITO</div>
                <div id="statCredito" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
        </div>

        <table id="tabelaRelatorioCompleto">
            <thead><tr><th>Data</th><th>Origem</th><th>Descri√ß√£o</th><th>Pagamento</th><th>Valor</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab-dashboard" class="tab-content">
        <h2>Dashboard Financeiro & Lucratividade</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="date" id="dashStart">
                <input type="date" id="dashEnd">
                <button class="btn btn-primary" onclick="atualizarDashboard()">Atualizar Gr√°ficos</button>
            </div>
        </div>

        <div style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
            <div class="stat-card">
                <div>Faturamento Bruto</div>
                <div id="dashFatBruto" style="font-size:1.5rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>Despesas Totais</div>
                <div id="dashDespesas" style="font-size:1.5rem; color:var(--danger)">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>Lucro L√≠quido</div>
                <div id="dashLucro" style="font-size:1.5rem; color:var(--primary)">R$ 0,00</div>
            </div>
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:20px;">
            <div class="glass-panel" style="flex:1; min-width:300px;">
                <h3>Fluxo de Caixa</h3>
                <canvas id="chartFluxo"></canvas>
            </div>
            <div class="glass-panel" style="flex:1; min-width:300px;">
                <h3>Despesas por Categoria</h3>
                <canvas id="chartCategorias"></canvas>
            </div>
        </div>
    </div>

</div>

<div id="modalEditCliente" class="modal"><div class="modal-content"><h3>Editar Cliente</h3><input type="hidden" id="editCliId"><input type="text" id="editCliNome" style="width:100%; margin-bottom:10px;"><input type="text" id="editCliTel" style="width:100%; margin-bottom:10px;"><input type="email" id="editCliEmail" style="width:100%; margin-bottom:10px;"><button class="btn btn-primary" onclick="atualizarCliente()" style="width:100%; margin-bottom:10px;">Salvar</button><button class="btn btn-danger" onclick="document.getElementById('modalEditCliente').style.display='none'" style="width:100%;">Cancelar</button></div></div>
<div id="modalEditProduto" class="modal"><div class="modal-content"><h3>Editar Produto</h3><input type="hidden" id="editProdId"><input type="text" id="editProdNome" style="width:100%; margin-bottom:10px;"><input type="number" id="editProdPreco" step="0.01" style="width:100%; margin-bottom:10px;"><input type="number" id="editProdEstoque" style="width:100%; margin-bottom:10px;"><input type="number" id="editProdMin" style="width:100%; margin-bottom:10px;"><button class="btn btn-primary" onclick="atualizarProduto()" style="width:100%; margin-bottom:10px;">Salvar</button><button class="btn btn-danger" onclick="document.getElementById('modalEditProduto').style.display='none'" style="width:100%;">Cancelar</button></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, Timestamp, onSnapshot, deleteDoc, doc, orderBy, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCXFxcygBteUYgUjuobsTSYVQRIJEgUFjA",
        authDomain: "cronometragem-kart.firebaseapp.com",
        projectId: "cronometragem-kart",
        storageBucket: "cronometragem-kart.firebasestorage.app",
        messagingSenderId: "494692374520",
        appId: "1:494692374520:web:d84624be4cc0b3d068280d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let tempDrivers = [];
    let allClients = [];
    let chartFluxoInstancia = null;
    let chartCategoriaInstancia = null;

    window.deletarBateria = async (id) => { if(confirm("Excluir agendamento?")) await deleteDoc(doc(db, "agendamentos", id)); };
    window.deletarVenda = async (id) => { if(confirm("Excluir venda?")) await deleteDoc(doc(db, "vendas_avulsas", id)); };
    window.deletarProduto = async (id) => { if(confirm("Excluir produto?")) await deleteDoc(doc(db, "produtos", id)); };
    window.deletarCliente = async (id) => { if(confirm("Excluir cliente?")) await deleteDoc(doc(db, "clientes", id)); };
    window.deletarDespesa = async (id) => { if(confirm("Excluir despesa?")) await deleteDoc(doc(db, "despesas", id)); };

    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(window.event) window.event.currentTarget.classList.add('active');
        if(tab === 'relatorios') gerarRelatorio();
        if(tab === 'dashboard') atualizarDashboard();
    };

    window.salvarCliente = async () => {
        const nome = document.getElementById('cliNome').value;
        if(!nome) return alert("Nome obrigat√≥rio!");
        await addDoc(collection(db, "clientes"), { nome, tel: document.getElementById('cliTelefone').value, email: document.getElementById('cliEmail').value, dataCadastro: Timestamp.now() });
        document.getElementById('cliNome').value = ""; document.getElementById('cliTelefone').value = ""; document.getElementById('cliEmail').value = "";
    };

    window.carregarClientes = () => {
        onSnapshot(query(collection(db, "clientes"), orderBy("nome")), (snap) => {
            const tb = document.querySelector('#tabelaClientes tbody'); tb.innerHTML = ""; allClients = [];
            snap.forEach(d => {
                const c = d.data(); allClients.push({id: d.id, ...c});
                tb.innerHTML += `<tr><td>${c.nome}</td><td>${c.tel || '-'}</td><td>${c.email || '-'}</td><td>
                    <button class="btn-blue" onclick='abrirEdicaoCliente(${JSON.stringify({id: d.id, ...c})})'>Editar</button> 
                    <button class="btn-danger" onclick="deletarCliente('${d.id}')">Excluir</button>
                </td></tr>`;
            });
        });
    };

    window.searchClient = (input, resultsId) => {
        const val = input.value.toLowerCase();
        const resDiv = document.getElementById(resultsId);
        if(val.length < 1) { resDiv.style.display = 'none'; return; }
        const filtered = allClients.filter(c => c.nome.toLowerCase().includes(val));
        resDiv.innerHTML = filtered.map(c => `<div class="search-item" onclick="document.getElementById('${input.id}').value='${c.nome}'; document.getElementById('${resultsId}').style.display='none'">${c.nome}</div>`).join('');
        resDiv.style.display = filtered.length > 0 ? 'block' : 'none';
    };

    window.addDriverToList = () => {
        const name = document.getElementById('driverName').value;
        const circuitSelect = document.getElementById('circuitSelect');
        const price = parseFloat(document.getElementById('driverPrice').value) || 0;
        const payment = document.getElementById('driverPayment').value;
        if(!name || !circuitSelect.value) return alert("Preencha Nome e Pista");
        tempDrivers.push({ name: name, pistaNome: JSON.parse(circuitSelect.value).name, id: Date.now(), laps: [], price, paymentMethod: payment });
        renderTempTable(); document.getElementById('driverName').value = "";
    };

    function renderTempTable() {
        const tbody = document.querySelector('#tempDriversTable tbody');
        let total = 0;
        tbody.innerHTML = tempDrivers.map((d, i) => { total += d.price; return `<tr><td>${d.name}</td><td>${d.pistaNome}</td><td>${d.paymentMethod}</td><td>R$ ${d.price.toFixed(2)}</td><td><button class="btn-danger" onclick="tempDrivers.splice(${i},1);renderTempTable()">X</button></td></tr>`; }).join('');
        document.getElementById('totalRaceValue').innerText = `R$ ${total.toFixed(2)}`;
    }

    window.saveBooking = async () => {
        const circuit = document.getElementById('circuitSelect').value;
        if(!document.getElementById('raceName').value || tempDrivers.length === 0) return alert("Preencha os dados da bateria");
        const totalValue = tempDrivers.reduce((sum, d) => sum + d.price, 0);
        await addDoc(collection(db, "agendamentos"), { 
            raceName: document.getElementById('raceName').value, 
            responsible: document.getElementById('responsible').value, 
            raceDate: document.getElementById('raceDate').value, 
            raceTime: document.getElementById('raceTime').value, 
            mode: document.getElementById('raceMode').value, 
            circuit: JSON.parse(circuit), 
            drivers: tempDrivers, 
            status: "pendente", 
            totalValue: totalValue,
            createdAt: Timestamp.now() 
        });
        alert("Agendado!"); tempDrivers = []; renderTempTable();
    };

    function loadBookings() {
        // CORRE√á√ÉO: Usamos apenas o orderBy e filtramos o status no c√≥digo para evitar erros de √≠ndice ausente no Firebase
        const q = query(collection(db, "agendamentos"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('bookingList'); list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                // Filtro manual de status para sumir ao iniciar e n√£o quebrar a exibi√ß√£o inicial
                if(data.status === "pendente") {
                    list.innerHTML += `<div class="glass-panel">
                        <div style="display:flex; justify-content:space-between;"><strong>${data.raceTime} - ${data.raceName}</strong><span>R$ ${data.totalValue?.toFixed(2) || '0.00'}</span></div>
                        <div>${data.drivers.map(p => `<span class="driver-tag">${p.name}</span>`).join('')}</div>
                        <button class="btn-danger" onclick="deletarBateria('${d.id}')">Excluir</button>
                    </div>`;
                }
            });
        });
    }

    window.cadastrarProduto = async () => {
        const nome = document.getElementById('novoProdNome').value;
        const preco = parseFloat(document.getElementById('novoProdPreco').value);
        if(!nome || isNaN(preco)) return alert("Preencha Nome e Pre√ßo");
        await addDoc(collection(db, "produtos"), { nome, preco, estoque: 0, estoqueMin: parseInt(document.getElementById('novoProdMin').value) || 0 });
        alert("Produto cadastrado!");
    };

    window.carregarProdutos = () => {
        onSnapshot(collection(db, "produtos"), (snap) => {
            const listEstoque = document.getElementById('listaEstoqueGeralBody');
            const selectVenda = document.getElementById('selectProdutoVenda');
            const selectEntrada = document.getElementById('selectEntradaProduto'); 

            listEstoque.innerHTML = ""; 
            selectVenda.innerHTML = "";
            if(selectEntrada) selectEntrada.innerHTML = "<option value=''>Selecione o produto...</option>"; 

            snap.forEach(d => {
                const p = d.data();
                listEstoque.innerHTML += `<tr><td>${p.nome}</td><td>R$ ${p.preco.toFixed(2)}</td><td>${p.estoque}</td><td>${p.estoqueMin}</td><td>${p.estoque <= p.estoqueMin ? '‚ö†Ô∏è' : '‚úÖ'}</td><td><button class="btn-danger" onclick="deletarProduto('${d.id}')">X</button></td></tr>`;
                selectVenda.innerHTML += `<option value='${JSON.stringify({id: d.id, ...p})}'>${p.nome}</option>`;
                if(selectEntrada) selectEntrada.innerHTML += `<option value='${d.id}'>${p.nome}</option>`;
            });
        });
        
        onSnapshot(query(collection(db, "vendas_avulsas"), orderBy("createdAt", "desc")), (snap) => {
            const tb = document.querySelector('#tabelaVendasAvulsas tbody'); tb.innerHTML = "";
            snap.forEach(d => {
                const v = d.data();
                tb.innerHTML += `<tr><td>${v.dataVenda}</td><td>${v.item}</td><td>${v.quantidade}</td><td>${v.paymentMethod}</td><td>R$ ${v.totalVenda.toFixed(2)}</td><td><button class="btn-danger" onclick="deletarVenda('${d.id}')">X</button></td></tr>`;
            });
        });
    };

    window.registrarEntrada = async () => {
        const id = document.getElementById('selectEntradaProduto').value;
        const qtd = parseInt(document.getElementById('entradaQtd').value);
        const custo = parseFloat(document.getElementById('entradaCusto').value);
        if(!id || !qtd || isNaN(custo)) return alert("Selecione o produto, quantidade e custo.");
        await updateDoc(doc(db, "produtos", id), { estoque: increment(qtd) });
        await addDoc(collection(db, "despesas"), { descricao: `Compra Estoque ID: ${id}`, categoria: 'CompraEstoque', valor: custo * qtd, dataDespesa: new Date().toISOString().split('T')[0], createdAt: Timestamp.now() });
        alert("Entrada registrada!");
    };

    window.realizarVendaAvulsa = async () => {
        const prod = JSON.parse(document.getElementById('selectProdutoVenda').value);
        const qtd = parseInt(document.getElementById('qtdProdutoVenda').value);
        const total = prod.preco * qtd;
        await addDoc(collection(db, "vendas_avulsas"), { item: prod.nome, quantidade: qtd, totalVenda: total, paymentMethod: document.getElementById('salePayment').value, dataVenda: new Date().toISOString().split('T')[0], createdAt: Timestamp.now() });
        await updateDoc(doc(db, "produtos", prod.id), { estoque: increment(-qtd) });
        alert("Venda realizada!");
    };

    window.salvarDespesa = async () => {
        const valor = parseFloat(document.getElementById('gastoValor').value);
        if(!valor) return alert("Informe o valor");
        await addDoc(collection(db, "despesas"), { descricao: document.getElementById('gastoDescricao').value, categoria: document.getElementById('gastoCategoria').value, valor: valor, dataDespesa: document.getElementById('gastoData').value, createdAt: Timestamp.now() });
        alert("Despesa registrada!");
    };

    function carregarDespesas() {
        onSnapshot(query(collection(db, "despesas"), orderBy("dataDespesa", "desc")), (snap) => {
            const tb = document.querySelector('#tabelaDespesas tbody'); tb.innerHTML = "";
            snap.forEach(d => {
                const g = d.data();
                tb.innerHTML += `<tr><td>${g.dataDespesa}</td><td>${g.descricao}</td><td>R$ ${g.valor.toFixed(2)}</td><td><button class="btn-danger" onclick="deletarDespesa('${d.id}')">X</button></td></tr>`;
            });
        });
    }

    window.gerarRelatorio = async () => {
        const start = document.getElementById('reportStart').value;
        const end = document.getElementById('reportEnd').value;
        const tb = document.querySelector('#tabelaRelatorioCompleto tbody'); tb.innerHTML = "";
        let tot = 0, din = 0, px = 0, deb = 0, cre = 0;

        const vSnap = await getDocs(collection(db, "vendas_avulsas"));
        vSnap.forEach(d => {
            const v = d.data();
            if((!start || v.dataVenda >= start) && (!end || v.dataVenda <= end)) {
                tot += v.totalVenda;
                if(v.paymentMethod === 'Dinheiro') din += v.totalVenda;
                else if(v.paymentMethod === 'PIX') px += v.totalVenda;
                else if(v.paymentMethod === 'D√©bito') deb += v.totalVenda;
                else if(v.paymentMethod === 'Cr√©dito') cre += v.totalVenda;
                tb.innerHTML += `<tr><td>${v.dataVenda}</td><td>Venda</td><td>${v.item}</td><td>${v.paymentMethod}</td><td>R$ ${v.totalVenda.toFixed(2)}</td></tr>`;
            }
        });

        const cSnap = await getDocs(collection(db, "agendamentos"));
        cSnap.forEach(d => {
            const c = d.data();
            if((!start || c.raceDate >= start) && (!end || c.raceDate <= end)) {
                c.drivers.forEach(dr => {
                    tot += dr.price;
                    if(dr.paymentMethod === 'Dinheiro') din += dr.price;
                    else if(dr.paymentMethod === 'PIX') px += dr.price;
                    else if(dr.paymentMethod === 'D√©bito') deb += dr.price;
                    else if(dr.paymentMethod === 'Cr√©dito') cre += dr.price;
                    tb.innerHTML += `<tr><td>${c.raceDate}</td><td>Corrida</td><td>${dr.name}</td><td>${dr.paymentMethod}</td><td>R$ ${dr.price.toFixed(2)}</td></tr>`;
                });
            }
        });

        document.getElementById('statTotal').innerText = `R$ ${tot.toFixed(2)}`;
        document.getElementById('statDinheiro').innerText = `R$ ${din.toFixed(2)}`;
        document.getElementById('statPIX').innerText = `R$ ${px.toFixed(2)}`;
        document.getElementById('statDebito').innerText = `R$ ${deb.toFixed(2)}`;
        document.getElementById('statCredito').innerText = `R$ ${cre.toFixed(2)}`;
    };

    window.atualizarDashboard = async () => {
        const start = document.getElementById('dashStart').value;
        const end = document.getElementById('dashEnd').value;
        let fat = 0, desp = 0; let cats = {};

        const vSnap = await getDocs(collection(db, "vendas_avulsas"));
        vSnap.forEach(d => { const v = d.data(); if((!start || v.dataVenda >= start) && (!end || v.dataVenda <= end)) fat += v.totalVenda; });
        const cSnap = await getDocs(collection(db, "agendamentos"));
        cSnap.forEach(d => { const c = d.data(); if((!start || c.raceDate >= start) && (!end || c.raceDate <= end)) fat += c.totalValue; });
        const dSnap = await getDocs(collection(db, "despesas"));
        dSnap.forEach(d => {
            const g = d.data();
            if((!start || g.dataDespesa >= start) && (!end || g.dataDespesa <= end)) {
                desp += g.valor; cats[g.categoria] = (cats[g.categoria] || 0) + g.valor;
            }
        });

        document.getElementById('dashFatBruto').innerText = `R$ ${fat.toFixed(2)}`;
        document.getElementById('dashDespesas').innerText = `R$ ${desp.toFixed(2)}`;
        document.getElementById('dashLucro').innerText = `R$ ${(fat - desp).toFixed(2)}`;

        const ctxFluxo = document.getElementById('chartFluxo').getContext('2d');
        if(chartFluxoInstancia) chartFluxoInstancia.destroy();
        chartFluxoInstancia = new Chart(ctxFluxo, {
            type: 'bar',
            data: { labels: ['Entradas', 'Sa√≠das'], datasets: [{ data: [fat, desp], backgroundColor: ['#00e676', '#ff1744'] }] },
            options: { plugins: { legend: { display: false } } }
        });

        const ctxCat = document.getElementById('chartCategorias').getContext('2d');
        if(chartCategoriaInstancia) chartCategoriaInstancia.destroy();
        chartCategoriaInstancia = new Chart(ctxCat, {
            type: 'pie',
            data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#2979ff', '#ffea00', '#ff1744', '#e040fb', '#00e676'] }] }
        });
    }

    async function loadCircuits() {
        const snap = await getDocs(collection(db, "circuits"));
        const sel = document.getElementById('circuitSelect'); sel.innerHTML = "";
        snap.forEach(d => { sel.innerHTML += `<option value='${JSON.stringify({id: d.id, ...d.data()})}'>${d.data().name}</option>`; });
    }

    window.onload = () => { 
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('raceDate').value = hoje;
        document.getElementById('reportStart').value = hoje;
        document.getElementById('reportEnd').value = hoje;
        document.getElementById('dashStart').value = hoje;
        document.getElementById('dashEnd').value = hoje;
        document.getElementById('gastoData').value = hoje;
        carregarClientes(); loadCircuits(); loadBookings(); carregarProdutos(); carregarDespesas();
    };
</script>
</body>
</html>
