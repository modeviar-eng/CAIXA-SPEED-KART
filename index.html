<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kart Manager Pro - Caixa - Sistema integrado</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #121212; --bg-panel: #1e1e1e; --primary: #00e676;
            --secondary: #2979ff; --danger: #ff1744; --warning: #ffea00;
            --text-main: #ffffff; --text-muted: #b0b0b0;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Desktop */
        .sidebar { width: 80px; background-color: #000; display: flex; flex-direction: column; align-items: center; padding-top: 20px; border-right: 1px solid #333; transition: width 0.3s; z-index: 10; flex-shrink: 0; }
        .sidebar:hover { width: 220px; }
        .nav-btn { background: none; border: none; color: var(--text-muted); width: 100%; padding: 15px; text-align: left; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; gap: 15px; transition: 0.2s; overflow: hidden; white-space: nowrap; }
        .nav-btn:hover, .nav-btn.active { color: var(--primary); background-color: rgba(0, 230, 118, 0.1); border-left: 3px solid var(--primary); }
        .nav-btn span { font-size: 0.9rem; font-weight: bold; }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .tab-content { display: none; padding-bottom: 80px; } 
        .tab-content.active { display: block; }
        
        .glass-panel { background: var(--bg-panel); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
        
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; position: relative; }
        input, select { background: #2a2a2a; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; flex: 1; font-size: 1rem; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: #000; } 
        .btn-blue { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--primary); color: #000; } /* Reusing primary for success look */
        
        /* Tabelas e Responsividade */
        .table-responsive { width: 100%; overflow-x: auto; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; /* Garante largura m√≠nima para scroll */ }
        th { text-align: left; background: #333; padding: 12px 10px; color: var(--primary); white-space: nowrap; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        
        .driver-tag { display: inline-block; background: #333; padding: 5px 10px; border-radius: 4px; margin: 2px; border: 1px solid var(--primary); font-size: 0.8rem; }
        
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #2a2a2a; border: 1px solid var(--primary); z-index: 100; max-height: 200px; overflow-y: auto; border-radius: 0 0 6px 6px; display: none; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; }
        .search-item:hover { background: #333; color: var(--primary); }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-panel); margin: 10% auto; padding: 25px; width: 400px; border-radius: 10px; border: 1px solid var(--primary); max-width: 90%; }
        
        .stat-card { background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); flex: 1; min-width: 140px; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        .split-item { display: flex; justify-content: space-between; padding: 5px; background: #333; margin-bottom: 5px; border-radius: 4px; font-size: 0.85rem; }

        /* AJUSTES MOBILE / CELULAR */
        @media (max-width: 768px) { 
            body { flex-direction: column; height: 100vh; } 
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; padding: 5px; border-right: none; 
                border-bottom: 1px solid #333; overflow-x: auto; white-space: nowrap; flex-shrink: 0;
            } 
            .sidebar:hover { width: 100%; }
            .nav-btn { width: auto; flex: 0 0 auto; padding: 10px 15px; border-left: none; border-bottom: 3px solid transparent; }
            .nav-btn:hover, .nav-btn.active { border-left: none; border-bottom: 3px solid var(--primary); }
            .main-content { padding: 10px; padding-bottom: 100px; }
            .form-row { flex-direction: column; gap: 10px; }
            .form-row > * { width: 100% !important; flex: none !important; margin-right: 0; }
            .modal-content { margin: 20% auto; width: 90%; }
            .glass-panel { padding: 15px; }
            h2 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
    <button class="nav-btn active" onclick="switchTab('clientes')"><span>üë• Clientes</span></button>
    <button class="nav-btn" onclick="switchTab('corridas')"><span>üèéÔ∏è Corridas</span></button>
    <button class="nav-btn" onclick="switchTab('modos')"><span>‚öôÔ∏è Modos</span></button>
    <button class="nav-btn" onclick="switchTab('historico')"><span>üèÅ Hist√≥rico</span></button> 
    <button class="nav-btn" onclick="switchTab('estoque')"><span>üì¶ Estoque</span></button>
    <button class="nav-btn" onclick="switchTab('entrada-produtos')"><span>üöõ Entrada</span></button>
    <button class="nav-btn" onclick="switchTab('venda-avulsa')"><span>üõí Vendas</span></button>
    <button class="nav-btn" onclick="switchTab('gastos')"><span>üí∏ Sa√≠da</span></button>
    <button class="nav-btn" onclick="switchTab('aportes')"><span>üí∞ Aportes</span></button> <button class="nav-btn" onclick="switchTab('relatorios')"><span>üìä Relat√≥rios</span></button>
    <button class="nav-btn" onclick="switchTab('dashboard')"><span>üìà Dash</span></button>
</nav>

<div class="main-content">
    
    <div id="tab-clientes" class="tab-content active">
        <h2>Cadastro de Clientes</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="text" id="cliNome" placeholder="Nome Completo">
                <input type="text" id="cliTelefone" placeholder="Telefone">
                <input type="email" id="cliEmail" placeholder="E-mail">
            </div>
            <div class="form-row">
                <select id="cliGenero">
                    <option value="">G√™nero...</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                </select>
                <select id="cliFaixaEtaria">
                    <option value="">Faixa Et√°ria...</option>
                    <option value="7 a 15">7 a 15 anos</option>
                    <option value="15 a 40">15 a 40 anos</option>
                    <option value="40 a 60">40 a 60 anos</option>
                    <option value="60+">60+ anos</option>
                </select>
                <input type="number" id="cliPeso" placeholder="Peso Aprox. (kg)">
                <button class="btn btn-primary" onclick="salvarCliente()">Salvar Cliente</button>
            </div>
        </div>
        <div class="glass-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
                <h3>Clientes Cadastrados</h3>
                <input type="text" id="searchTable" placeholder="üîç Pesquisar por nome..." style="max-width:300px; width: 100%;" onkeyup="carregarClientes()">
            </div>
            <div class="table-responsive">
                <table id="tabelaClientes">
                    <thead><tr><th>Nome</th><th>Telefone</th><th>G√™nero</th><th>Idade/Peso</th><th>A√ß√£o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-modos" class="tab-content">
        <h2>Configurar Modos de Corrida</h2>
        <div class="glass-panel">
            <p style="color:#aaa; font-size:0.9rem;">Crie predefini√ß√µes (ex: GP 20 min) que geram automaticamente a Tomada de Tempo e a Corrida.</p>
            <div class="form-row">
                <input type="text" id="newModeName" placeholder="Nome do Modo (ex: GP Amador)">
            </div>
            <div id="stagesContainer">
                <div class="form-row stage-row">
                    <span style="align-self:center; color:var(--primary); font-weight:bold;">Etapa 1:</span>
                    <select class="stage-type">
                        <option value="tomada">Tomada de Tempo</option>
                        <option value="corrida">Corrida</option>
                    </select>
                    <input type="text" class="stage-suffix" placeholder="Sufixo (ex: Classifica√ß√£o)">
                </div>
            </div>
            <div class="form-row">
                <button class="btn btn-blue" onclick="addStageRow()">+ Adicionar Etapa</button>
                <button class="btn btn-primary" onclick="saveRaceMode()">Salvar Modo</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Modos Salvos</h3>
            <div class="table-responsive">
                <table id="tabelaModos">
                    <thead><tr><th>Nome do Modo</th><th>Etapas</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="listaModosBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-corridas" class="tab-content">
        <h2>Agendar Nova Bateria</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="text" id="raceName" placeholder="Nome da Bateria">
                <div style="flex:1; position:relative;">
                    <input type="text" id="responsible" placeholder="Respons√°vel" onkeyup="searchClient(this, 'res_results')">
                    <div id="res_results" class="search-results"></div>
                </div>
                <input type="date" id="raceDate">
                <input type="time" id="raceTime">
            </div>
            <div class="form-row">
                <select id="presetModeSelect" style="border: 1px solid var(--primary); color: var(--primary); font-weight: bold;">
                    <option value="">-- Carregar Modo Pr√©-definido --</option>
                </select>
                
                <select id="raceMode">
                    <option value="corrida">Modo Manual: Corrida</option>
                    <option value="tomada">Modo Manual: Tomada de Tempo</option>
                </select>
                <select id="circuitSelect"><option value="">Carregando pistas...</option></select>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Adicionar Pilotos</h3>
            <div class="form-row">
                <div style="flex:2; position:relative;">
                    <input type="text" id="driverName" placeholder="Nome do Piloto" onkeyup="searchClient(this, 'driver_results')">
                    <div id="driver_results" class="search-results"></div>
                </div>
                <input type="number" id="driverPrice" placeholder="Valor Total (R$)" step="0.01" style="flex:1;">
                <select id="driverPayment" style="flex:1;">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="D√©bito">D√©bito</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                    <option value="Cortesia">Cortesia</option>
                    <option value="Misto" style="color:var(--warning); font-weight:bold;">+ M√∫ltiplos (Misto)</option>
                </select>
                <button class="btn btn-blue" onclick="addDriverToTempList()">+ Adicionar</button>
            </div>
            <div class="table-responsive">
                <table id="tempDriversTable">
                    <thead><tr><th>Piloto</th><th>Pista</th><th>Pagamento</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align:right; font-weight:bold;">TOTAL BATERIA:</td>
                            <td id="totalRaceValue" style="color:var(--primary); font-weight:bold;">R$ 0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="saveBooking()" style="width: 100%;">ENVIAR PARA CRONOMETRAGEM</button>
            </div>
        </div>
        <h3>Baterias Agendadas</h3>
        <div id="bookingList"></div>
    </div>

    <div id="tab-historico" class="tab-content">
        <h2>Hist√≥rico de Corridas</h2>
        <div class="glass-panel">
            <div class="form-row">
                <label style="align-self:center; color:#ccc;">De:</label>
                <input type="date" id="histStart">
                <label style="align-self:center; color:#ccc;">At√©:</label>
                <input type="date" id="histEnd">
                <button class="btn btn-primary" onclick="carregarHistoricoCorridas()">Filtrar</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Resultados da Pesquisa</h3>
            <div class="table-responsive">
                <table id="tabelaHistorico">
                    <thead><tr><th>Data</th><th>Hora</th><th>Bateria</th><th>Respons√°vel</th><th>Status</th><th>Total</th><th>A√ß√µes</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="tab-estoque" class="tab-content">
        <h2>Gest√£o de Estoque</h2>
        <div class="glass-panel">
            <h3>Cadastrar Novo Produto</h3>
            <div class="form-row">
                <input type="text" id="novoProdNome" placeholder="Nome do Produto" style="flex: 2;">
                <input type="number" id="novoProdPreco" placeholder="Pre√ßo de Venda" step="0.01">
                <input type="number" id="novoProdMin" placeholder="M√≠nimo" style="flex: 1;">
                <button class="btn btn-primary" onclick="cadastrarProduto()">Criar Produto</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Estoque Atual</h3>
            <div class="table-responsive">
                <table id="tabelaEstoqueGeral">
                    <thead><tr><th>Produto</th><th>Pre√ßo</th><th>Qtd</th><th>M√≠n.</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="listaEstoqueGeralBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-entrada-produtos" class="tab-content">
        <h2>Entrada de Mercadoria</h2>
        <div class="glass-panel">
            <div class="form-row">
                <select id="selectEntradaProduto"><option value="">Carregando...</option></select>
                <input type="number" id="entradaQtd" placeholder="Qtd">
                <input type="number" id="entradaCusto" placeholder="Custo Un." step="0.01">
                <select id="entradaPagamento">
                    <option value="Dinheiro">Dinheiro (Caixa)</option>
                    <option value="PIX">PIX</option>
                </select>
                <button class="btn btn-primary" onclick="registrarEntrada()">Registrar</button>
            </div>
        </div>
    </div>

    <div id="tab-venda-avulsa" class="tab-content">
        <h2>Nova Venda R√°pida</h2>
        <div class="glass-panel">
            <div class="form-row">
                <select id="selectProdutoVenda"></select>
                <input type="number" id="qtdProdutoVenda" value="1" min="1">
                <select id="salePayment">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="D√©bito">D√©bito</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                </select>
                <button class="btn btn-primary" onclick="realizarVendaAvulsa()">Finalizar Venda</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>√öltimas Vendas (Hoje)</h3>
            <div class="table-responsive">
                <table id="tabelaVendasAvulsas">
                    <thead><tr><th>Data</th><th>Item</th><th>Qtd</th><th>Pagamento</th><th>Total</th><th>A√ß√£o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-gastos" class="tab-content">
        <h2>Registro de Despesas</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="text" id="gastoDescricao" placeholder="Descri√ß√£o" style="flex: 2;">
                <select id="gastoCategoria" style="flex:1;">
                    <option value="Aluguel">Aluguel</option>
                    <option value="Funcionarios">Funcion√°rios</option>
                    <option value="AguaLuz">Utilidades (√Ågua/Luz)</option>
                    <option value="Manutencao">Manuten√ß√£o</option>
                    <option value="CompraEstoque">Estoque</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div class="form-row">
                <input type="number" id="gastoValor" placeholder="Valor (R$)" step="0.01">
                <input type="date" id="gastoData">
                <button class="btn btn-danger" onclick="salvarDespesa()">Registrar Sa√≠da</button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="tabelaDespesas">
                <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-aportes" class="tab-content">
        <h2>Registrar Aporte (Investimento)</h2>
        <div class="glass-panel">
            <p style="color:#aaa; font-size:0.9rem;">Registre aqui valores adicionados ao caixa que n√£o prov√™m de vendas (ex: Dinheiro do bolso, troco inicial).</p>
            <div class="form-row">
                <input type="text" id="aporteDescricao" placeholder="Descri√ß√£o (ex: Dinheiro do Bolso)">
                <input type="number" id="aporteValor" placeholder="Valor (R$)" step="0.01">
                <input type="date" id="aporteData">
                <button class="btn btn-blue" onclick="salvarAporte()">Registrar Aporte</button>
            </div>
        </div>
        <div class="glass-panel">
            <h3>Hist√≥rico de Aportes</h3>
            <div class="table-responsive">
                <table id="tabelaAportes">
                    <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√£o</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-relatorios" class="tab-content">
        <h2>Relat√≥rio Financeiro</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="date" id="reportStart">
                <input type="date" id="reportEnd">
                <button class="btn btn-blue" onclick="gerarRelatorio()">üîç Filtrar</button>
            </div>
        </div>
        
        <div style="display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;">
            <div class="stat-card">
                <div>TOTAL ENTRADAS</div>
                <div id="statTotal" style="font-size:1.5rem; color:var(--primary)">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>DINHEIRO</div>
                <div id="statDinheiro" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>PIX</div>
                <div id="statPIX" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>D√âBITO</div>
                <div id="statDebito" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>CR√âDITO</div>
                <div id="statCredito" style="font-size:1.2rem;">R$ 0,00</div>
            </div>
        </div>

        <div class="table-responsive">
            <table id="tabelaRelatorioCompleto">
                <thead><tr><th>Data</th><th>Origem</th><th>Descri√ß√£o</th><th>Pagamento</th><th>Valor</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-dashboard" class="tab-content">
        <h2>Dashboard Financeiro & Lucratividade</h2>
        <div class="glass-panel">
            <div class="form-row">
                <input type="date" id="dashStart">
                <input type="date" id="dashEnd">
                <button class="btn btn-primary" onclick="atualizarDashboard()">Atualizar Gr√°ficos</button>
            </div>
        </div>

        <div style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
            <div class="stat-card">
                <div>Faturamento Bruto</div>
                <div id="dashFatBruto" style="font-size:1.5rem;">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>Despesas Totais</div>
                <div id="dashDespesas" style="font-size:1.5rem; color:var(--danger)">R$ 0,00</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--secondary);">
                <div>Total Aportes</div>
                <div id="dashAportes" style="font-size:1.5rem; color:var(--secondary)">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div>Saldo Final (Caixa)</div>
                <div id="dashSaldo" style="font-size:1.5rem; color:var(--primary)">R$ 0,00</div>
            </div>
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom: 20px;">
            <div class="glass-panel" style="flex:1; min-width:300px;">
                <h3>Fluxo de Caixa</h3>
                <canvas id="chartFluxo"></canvas>
            </div>
            <div class="glass-panel" style="flex:1; min-width:300px;">
                <h3>Despesas por Categoria</h3>
                <canvas id="chartCategorias"></canvas>
            </div>
        </div>

        <div class="glass-panel">
            <h3>Detalhamento do Per√≠odo (Hist√≥rico)</h3>
            <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 10px;">
                * Baterias e Vendas s√£o unificadas por data. Despesas e Aportes s√£o listados individualmente para edi√ß√£o/exclus√£o.
            </p>
            <div class="table-responsive">
                <table id="tabelaDashDetalhada">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descri√ß√£o / Grupo</th>
                            <th>Tipo</th>
                            <th>Valor (R$)</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div id="modalEditCliente" class="modal">
    <div class="modal-content">
        <h3>Editar Cliente</h3>
        <input type="hidden" id="editCliId">
        <label>Nome:</label>
        <input type="text" id="editCliNome" style="width:100%; margin-bottom:10px;">
        <label>Telefone:</label>
        <input type="text" id="editCliTel" style="width:100%; margin-bottom:10px;">
        <label>E-mail:</label>
        <input type="email" id="editCliEmail" style="width:100%; margin-bottom:10px;">
        
        <label>G√™nero:</label>
        <select id="editCliGenero" style="width:100%; margin-bottom:10px; padding:10px; background:#2a2a2a; color:white; border:1px solid #444; border-radius:6px;">
            <option value="">Selecione...</option>
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
        </select>
        
        <label>Faixa Et√°ria:</label>
        <select id="editCliFaixaEtaria" style="width:100%; margin-bottom:10px; padding:10px; background:#2a2a2a; color:white; border:1px solid #444; border-radius:6px;">
            <option value="">Selecione...</option>
            <option value="7 a 15">7 a 15 anos</option>
            <option value="15 a 40">15 a 40 anos</option>
            <option value="40 a 60">40 a 60 anos</option>
            <option value="60+">60+ anos</option>
        </select>
        
        <label>Peso Aprox. (kg):</label>
        <input type="number" id="editCliPeso" style="width:100%; margin-bottom:15px;">

        <button class="btn btn-primary" onclick="atualizarCliente()" style="width:100%; margin-bottom:10px;">Salvar</button>
        <button class="btn btn-danger" onclick="document.getElementById('modalEditCliente').style.display='none'" style="width:100%;">Cancelar</button>
    </div>
</div>
<div id="modalEditProduto" class="modal"><div class="modal-content"><h3>Editar Produto</h3><input type="hidden" id="editProdId"><input type="text" id="editProdNome" style="width:100%; margin-bottom:10px;"><input type="number" id="editProdPreco" step="0.01" style="width:100%; margin-bottom:10px;"><input type="number" id="editProdEstoque" style="width:100%; margin-bottom:10px;"><input type="number" id="editProdMin" style="width:100%; margin-bottom:10px;"><button class="btn btn-primary" onclick="atualizarProduto()" style="width:100%; margin-bottom:10px;">Salvar</button><button class="btn btn-danger" onclick="document.getElementById('modalEditProduto').style.display='none'" style="width:100%;">Cancelar</button></div></div>

<div id="modalEditCorrida" class="modal">
    <div class="modal-content">
        <h3>Editar Dados da Corrida</h3>
        <input type="hidden" id="editRaceId">
        <label>Nome da Bateria:</label>
        <input type="text" id="editRaceName" style="width:100%; margin-bottom:10px;">
        <label>Respons√°vel:</label>
        <input type="text" id="editRaceResp" style="width:100%; margin-bottom:10px;">
        <label>Data:</label>
        <input type="date" id="editRaceDate" style="width:100%; margin-bottom:10px;">
        <label>Hora:</label>
        <input type="time" id="editRaceTime" style="width:100%; margin-bottom:10px;">
        <label>Status:</label>
        <select id="editRaceStatus" style="width:100%; margin-bottom:15px; background:#2a2a2a; color:white; padding:10px;">
            <option value="pendente">Pendente</option>
            <option value="finalizada">Finalizada</option>
            <option value="cancelada">Cancelada</option>
        </select>
        <button class="btn btn-primary" onclick="salvarEdicaoCorrida()" style="width:100%; margin-bottom:10px;">Salvar Altera√ß√µes</button>
        <button class="btn btn-danger" onclick="document.getElementById('modalEditCorrida').style.display='none'" style="width:100%;">Cancelar</button>
    </div>
</div>

<div id="modalSplitPayment" class="modal">
    <div class="modal-content">
        <h3>Pagamento Misto - <span id="splitDriverName" style="color:var(--primary)"></span></h3>
        <h4 style="margin:5px 0;">Total Necess√°rio: R$ <span id="splitTotalReq">0.00</span></h4>
        
        <div id="splitList" style="margin:15px 0; border:1px solid #444; padding:10px; border-radius:6px; min-height:50px;"></div>
        
        <div class="form-row" style="margin-bottom:10px;">
             <input type="number" id="splitPartValue" placeholder="Valor (R$)" step="0.01">
             <select id="splitPartMethod">
                <option value="Dinheiro">Dinheiro</option>
                <option value="PIX">PIX</option>
                <option value="D√©bito">D√©bito</option>
                <option value="Cr√©dito">Cr√©dito</option>
             </select>
             <button class="btn btn-blue" onclick="addSplitPart()">+</button>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
            <span id="splitRemaining" style="color:var(--danger); font-weight:bold;">Restante: R$ 0.00</span>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-primary" onclick="finalizeSplitDriver()">Confirmar</button>
                <button class="btn btn-danger" onclick="closeSplitModal()">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, Timestamp, onSnapshot, deleteDoc, doc, orderBy, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCXFxcygBteUYgUjuobsTSYVQRIJEgUFjA",
        authDomain: "cronometragem-kart.firebaseapp.com",
        projectId: "cronometragem-kart",
        storageBucket: "cronometragem-kart.firebasestorage.app",
        messagingSenderId: "494692374520",
        appId: "1:494692374520:web:d84624be4cc0b3d068280d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let tempDrivers = [];
    let allClients = [];
    let chartFluxoInstancia = null;
    let chartCategoriaInstancia = null;
    let allRaceModes = [];

    // Vari√°veis para pagamento misto
    let currentSplitDriver = null; 
    window.currentSplitPayments = [];

    window.deletarBateria = async (id) => { if(confirm("Excluir agendamento?")) await deleteDoc(doc(db, "agendamentos", id)); };
    window.deletarVenda = async (id) => { if(confirm("Excluir venda?")) await deleteDoc(doc(db, "vendas_avulsas", id)); };
    window.deletarProduto = async (id) => { if(confirm("Excluir produto?")) await deleteDoc(doc(db, "produtos", id)); };
    window.deletarCliente = async (id) => { if(confirm("Excluir cliente?")) await deleteDoc(doc(db, "clientes", id)); };
    
    // Fun√ß√µes globais para o dashboard
    window.deletarDespesa = async (id) => { 
        if(confirm("Excluir despesa permanentemente?")) {
            await deleteDoc(doc(db, "despesas", id));
            atualizarDashboard(); // Recarrega o dash
        }
    };
    window.deletarModo = async (id) => { if(confirm("Excluir este modo?")) await deleteDoc(doc(db, "race_modes", id)); };
    window.deletarAporte = async (id) => { 
        if(confirm("Excluir este aporte permanentemente?")) {
            await deleteDoc(doc(db, "aportes", id));
            atualizarDashboard(); // Recarrega o dash
        }
    };

    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(window.event) window.event.currentTarget.classList.add('active');
        if(tab === 'relatorios') gerarRelatorio();
        if(tab === 'dashboard') atualizarDashboard();
        if(tab === 'historico') carregarHistoricoCorridas();
    };

    window.salvarCliente = async () => {
        const nome = document.getElementById('cliNome').value;
        if(!nome) return alert("Nome obrigat√≥rio!");
        
        await addDoc(collection(db, "clientes"), { 
            nome, 
            tel: document.getElementById('cliTelefone').value, 
            email: document.getElementById('cliEmail').value,
            genero: document.getElementById('cliGenero').value,
            faixaEtaria: document.getElementById('cliFaixaEtaria').value,
            peso: document.getElementById('cliPeso').value,
            dataCadastro: Timestamp.now() 
        });

        document.getElementById('cliNome').value = ""; 
        document.getElementById('cliTelefone').value = ""; 
        document.getElementById('cliEmail').value = "";
        document.getElementById('cliGenero').value = "";
        document.getElementById('cliFaixaEtaria').value = "";
        document.getElementById('cliPeso').value = "";
        alert("Cliente salvo!");
    };

    window.abrirEdicaoCliente = (data) => {
        document.getElementById('editCliId').value = data.id;
        document.getElementById('editCliNome').value = data.nome;
        document.getElementById('editCliTel').value = data.tel || '';
        document.getElementById('editCliEmail').value = data.email || '';
        document.getElementById('editCliGenero').value = data.genero || '';
        document.getElementById('editCliFaixaEtaria').value = data.faixaEtaria || '';
        document.getElementById('editCliPeso').value = data.peso || '';
        document.getElementById('modalEditCliente').style.display = 'block';
    };

    window.atualizarCliente = async () => {
        const id = document.getElementById('editCliId').value;
        await updateDoc(doc(db, "clientes", id), {
            nome: document.getElementById('editCliNome').value,
            tel: document.getElementById('editCliTel').value,
            email: document.getElementById('editCliEmail').value,
            genero: document.getElementById('editCliGenero').value,
            faixaEtaria: document.getElementById('editCliFaixaEtaria').value,
            peso: document.getElementById('editCliPeso').value
        });
        document.getElementById('modalEditCliente').style.display = 'none';
        alert("Cliente atualizado!");
    };

    window.carregarClientes = () => {
        onSnapshot(query(collection(db, "clientes"), orderBy("nome")), (snap) => {
            const tb = document.querySelector('#tabelaClientes tbody'); tb.innerHTML = ""; allClients = [];
            snap.forEach(d => {
                const c = d.data(); 
                const clienteData = {id: d.id, ...c};
                allClients.push(clienteData);
                
                const tr = document.createElement('tr');
                const infoExtra = `${c.faixaEtaria ? c.faixaEtaria : '-'} | ${c.peso ? c.peso + 'kg' : '-'}`;
                
                tr.innerHTML = `
                    <td>${c.nome}</td>
                    <td>${c.tel || '-'}</td>
                    <td>${c.genero || '-'}</td>
                    <td>${infoExtra}</td>
                    <td>
                        <button class="btn-blue btn-edit-cli">Editar</button> 
                        <button class="btn-danger" onclick="deletarCliente('${d.id}')">Excluir</button>
                    </td>`;
                
                tr.querySelector('.btn-edit-cli').onclick = () => window.abrirEdicaoCliente(clienteData);
                tb.appendChild(tr);
            });
        });
    };

    window.searchClient = (input, resultsId) => {
        const val = input.value.toLowerCase();
        const resDiv = document.getElementById(resultsId);
        if(val.length < 1) { resDiv.style.display = 'none'; return; }
        const filtered = allClients.filter(c => c.nome.toLowerCase().includes(val));
        resDiv.innerHTML = filtered.map(c => `<div class="search-item" onclick="document.getElementById('${input.id}').value='${c.nome}'; document.getElementById('${resultsId}').style.display='none'">${c.nome}</div>`).join('');
        resDiv.style.display = filtered.length > 0 ? 'block' : 'none';
    };

    /* --- L√ìGICA DE MODOS DE CORRIDA --- */
    window.addStageRow = () => {
        const div = document.createElement('div');
        div.className = 'form-row stage-row';
        div.innerHTML = `
            <span style="align-self:center; color:var(--primary); font-weight:bold;">Etapa:</span>
            <select class="stage-type">
                <option value="tomada">Tomada de Tempo</option>
                <option value="corrida">Corrida</option>
            </select>
            <input type="text" class="stage-suffix" placeholder="Sufixo (ex: Corrida 2)">
            <button class="btn-danger" onclick="this.parentElement.remove()" style="padding:5px 10px;">X</button>
        `;
        document.getElementById('stagesContainer').appendChild(div);
    };

    window.saveRaceMode = async () => {
        const name = document.getElementById('newModeName').value;
        if(!name) return alert("D√™ um nome ao modo!");
        const stages = [];
        document.querySelectorAll('.stage-row').forEach(row => {
            stages.push({
                type: row.querySelector('.stage-type').value,
                suffix: row.querySelector('.stage-suffix').value
            });
        });
        await addDoc(collection(db, "race_modes"), { name, stages, createdAt: Timestamp.now() });
        alert("Modo salvo!");
        document.getElementById('newModeName').value = "";
    };

    function loadRaceModes() {
        onSnapshot(query(collection(db, "race_modes"), orderBy("name")), (snap) => {
            const tb = document.getElementById('listaModosBody');
            const sel = document.getElementById('presetModeSelect');
            tb.innerHTML = "";
            sel.innerHTML = '<option value="">-- Carregar Modo Pr√©-definido --</option>';
            allRaceModes = [];
            
            snap.forEach(d => {
                const m = d.data();
                allRaceModes.push({id: d.id, ...m});
                
                // Popula Tabela na aba Modos
                const stagesDesc = m.stages.map(s => `${s.suffix} (${s.type})`).join(', ');
                tb.innerHTML += `<tr><td>${m.name}</td><td>${stagesDesc}</td><td><button class="btn-danger" onclick="deletarModo('${d.id}')">X</button></td></tr>`;
                
                // Popula Select na aba Corridas
                sel.innerHTML += `<option value="${d.id}">${m.name}</option>`;
            });
        });
    }

    /* L√ìGICA DE PAGAMENTO MISTO E ADI√á√ÉO DE PILOTO */
    window.addDriverToTempList = () => {
        const name = document.getElementById('driverName').value;
        const circuitSelect = document.getElementById('circuitSelect');
        const price = parseFloat(document.getElementById('driverPrice').value) || 0;
        const payment = document.getElementById('driverPayment').value;

        if(!name || !circuitSelect.value) return alert("Preencha Nome e Pista");

        // Se for Pagamento Misto, abre o modal
        if(payment === 'Misto') {
            if(price <= 0) return alert("Informe o valor total antes de dividir.");
            openSplitModal(name, price, JSON.parse(circuitSelect.value).name);
            return;
        }

        // Fluxo normal (pagamento √∫nico)
        tempDrivers.push({ 
            name: name, 
            pistaNome: JSON.parse(circuitSelect.value).name, 
            id: Date.now(), 
            laps: [], 
            price, 
            paymentMethod: payment 
        });
        renderTempTable(); 
        document.getElementById('driverName').value = "";
        document.getElementById('driverPrice').value = ""; // Limpa pre√ßo tamb√©m
    };

    // Abre o modal de pagamento misto
    window.openSplitModal = (name, total, pista) => {
        currentSplitDriver = { name, total, pista };
        window.currentSplitPayments = [];
        document.getElementById('splitDriverName').innerText = name;
        document.getElementById('splitTotalReq').innerText = total.toFixed(2);
        document.getElementById('modalSplitPayment').style.display = 'block';
        updateSplitUI();
    };

    // Adiciona uma parte do pagamento na lista tempor√°ria do modal
    window.addSplitPart = () => {
        const val = parseFloat(document.getElementById('splitPartValue').value);
        const method = document.getElementById('splitPartMethod').value;
        if(!val || val <= 0) return;
        
        window.currentSplitPayments.push({ value: val, method: method });
        document.getElementById('splitPartValue').value = "";
        updateSplitUI();
    };

    // Atualiza a lista visual dentro do modal e o c√°lculo do restante
    function updateSplitUI() {
        const list = document.getElementById('splitList');
        const totalPaid = window.currentSplitPayments.reduce((acc, cur) => acc + cur.value, 0);
        const remaining = currentSplitDriver.total - totalPaid;
        
        list.innerHTML = "";
        window.currentSplitPayments.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = "split-item";
            div.innerHTML = `<span>${p.method}: R$ ${p.value.toFixed(2)}</span>`;
            const btn = document.createElement('button');
            btn.style.cssText = "background:none; border:none; color:var(--danger); cursor:pointer;";
            btn.innerText = "X";
            btn.onclick = () => {
                window.currentSplitPayments.splice(i, 1);
                updateSplitUI();
            };
            div.appendChild(btn);
            list.appendChild(div);
        });

        const elRem = document.getElementById('splitRemaining');
        elRem.innerText = `Restante: R$ ${remaining.toFixed(2)}`;
        elRem.style.color = Math.abs(remaining) < 0.01 ? 'var(--primary)' : 'var(--danger)';
    }

    window.closeSplitModal = () => {
        document.getElementById('modalSplitPayment').style.display = 'none';
        currentSplitDriver = null;
        window.currentSplitPayments = [];
    };

    // Finaliza a adi√ß√£o do piloto com pagamento misto
    window.finalizeSplitDriver = () => {
        const totalPaid = window.currentSplitPayments.reduce((acc, cur) => acc + cur.value, 0);
        // Pequena toler√¢ncia para erros de ponto flutuante
        if(Math.abs(totalPaid - currentSplitDriver.total) > 0.05) {
            alert(`O total dos pagamentos (R$ ${totalPaid.toFixed(2)}) n√£o bate com o valor do piloto (R$ ${currentSplitDriver.total.toFixed(2)})!`);
            return;
        }

        tempDrivers.push({ 
            name: currentSplitDriver.name, 
            pistaNome: currentSplitDriver.pista, 
            id: Date.now(), 
            laps: [], 
            price: currentSplitDriver.total, 
            paymentMethod: "Misto",
            splitPayments: [...window.currentSplitPayments] // Salva o array de pagamentos
        });

        renderTempTable();
        document.getElementById('driverName').value = "";
        document.getElementById('driverPrice').value = "";
        closeSplitModal();
    };

    function renderTempTable() {
        const tbody = document.querySelector('#tempDriversTable tbody');
        tbody.innerHTML = "";
        let total = 0;
        
        tempDrivers.forEach((d, i) => { 
            total += d.price; 
            
            // Exibi√ß√£o amig√°vel do m√©todo
            let methodDisplay = d.paymentMethod;
            if(d.paymentMethod === 'Misto' && d.splitPayments) {
                const details = d.splitPayments.map(p => `${p.method.substr(0,3)}:${p.value}`).join(', ');
                methodDisplay = `Misto (${details})`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.name}</td>
                <td>${d.pistaNome}</td>
                <td><span style="font-size:0.8rem; color:${d.paymentMethod === 'Misto' ? '#ccc' : 'inherit'};">${methodDisplay}</span></td>
                <td>R$ ${d.price.toFixed(2)}</td>
                <td></td>
            `;
            
            const btnDel = document.createElement('button');
            btnDel.className = "btn-danger";
            btnDel.innerText = "X";
            btnDel.onclick = () => {
                tempDrivers.splice(i, 1);
                renderTempTable();
            };
            
            tr.cells[4].appendChild(btnDel);
            tbody.appendChild(tr);
        });
        
        document.getElementById('totalRaceValue').innerText = `R$ ${total.toFixed(2)}`;
    }

    window.saveBooking = async () => {
        const circuit = document.getElementById('circuitSelect').value;
        const rName = document.getElementById('raceName').value;
        const presetId = document.getElementById('presetModeSelect').value;
        
        if(!rName || tempDrivers.length === 0) return alert("Preencha os dados da bateria");
        
        const totalValue = tempDrivers.reduce((sum, d) => sum + d.price, 0);
        const responsible = document.getElementById('responsible').value;
        const rDate = document.getElementById('raceDate').value;
        const rTime = document.getElementById('raceTime').value;

        // Se tiver um preset selecionado (Multi-Stage)
        if (presetId) {
            const modeDoc = allRaceModes.find(m => m.id === presetId);
            if(modeDoc) {
                // Iterar sobre as etapas
                for (let i = 0; i < modeDoc.stages.length; i++) {
                    const stage = modeDoc.stages[i];
                    
                    // L√≥gica Financeira: 
                    // A primeira etapa (i===0) leva o valor total para contar no caixa.
                    // As demais levam valor 0 para n√£o duplicar receita no Dashboard.
                    let stageDrivers = [];
                    let stageTotal = 0;

                    if (i === 0) {
                        stageDrivers = [...tempDrivers]; // C√≥pia normal com pre√ßos
                        stageTotal = totalValue;
                    } else {
                        // C√≥pia zerando os pre√ßos para n√£o duplicar financeiro
                        stageDrivers = tempDrivers.map(d => ({
                            ...d,
                            price: 0,
                            // Mantemos o m√©todo de pagamento original apenas para refer√™ncia visual, 
                            // mas como o valor √© 0, n√£o afeta a soma.
                            paymentMethod: d.paymentMethod 
                        }));
                        stageTotal = 0;
                    }

                    // Nome da Bateria + Sufixo (ex: "Bateria Amigos - Tomada")
                    const fullName = `${rName} - ${stage.suffix}`;

                    await addDoc(collection(db, "agendamentos"), { 
                        raceName: fullName, 
                        responsible: responsible, 
                        raceDate: rDate, 
                        raceTime: rTime, // Poderia adicionar +minutos aqui se quisesse refinar
                        mode: stage.type, 
                        circuit: JSON.parse(circuit), 
                        drivers: stageDrivers, 
                        status: "pendente", 
                        totalValue: stageTotal,
                        createdAt: Timestamp.now(),
                        isMultiStage: true
                    });
                }
                alert(`Agendamento M√∫ltiplo (${modeDoc.name}) Realizado!`);
            }
        } else {
            // Modo Manual (√önico)
            const mode = document.getElementById('raceMode').value;
            await addDoc(collection(db, "agendamentos"), { 
                raceName: rName, 
                responsible: responsible, 
                raceDate: rDate, 
                raceTime: rTime, 
                mode: mode, 
                circuit: JSON.parse(circuit), 
                drivers: tempDrivers, 
                status: "pendente", 
                totalValue: totalValue,
                createdAt: Timestamp.now() 
            });
            alert("Agendado!"); 
        }

        // Limpeza
        tempDrivers = []; 
        renderTempTable();
        document.getElementById('raceName').value = "";
        document.getElementById('responsible').value = "";
        document.getElementById('raceTime').value = "";
        document.getElementById('raceDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('presetModeSelect').value = "";
    };

    function loadBookings() {
        const q = query(collection(db, "agendamentos"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('bookingList'); list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                if(data.status === "pendente") {
                    list.innerHTML += `<div class="glass-panel">
                        <div style="display:flex; justify-content:space-between;"><strong>${data.raceTime} - ${data.raceName}</strong><span>R$ ${data.totalValue?.toFixed(2) || '0.00'}</span></div>
                        <div>${data.drivers.map(p => `<span class="driver-tag">${p.name}</span>`).join('')}</div>
                        <button class="btn-danger" onclick="deletarBateria('${d.id}')">Excluir</button>
                    </div>`;
                }
            });
        });
    }

    /* --- HIST√ìRICO --- */
    window.carregarHistoricoCorridas = async () => {
        const start = document.getElementById('histStart').value;
        const end = document.getElementById('histEnd').value;
        const tb = document.querySelector('#tabelaHistorico tbody');
        tb.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
        const q = query(collection(db, "agendamentos"), orderBy("raceDate", "desc"));
        const snapshot = await getDocs(q);
        tb.innerHTML = ""; let encontrou = false;
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            if(d.raceDate >= start && d.raceDate <= end) {
                encontrou = true;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.raceDate.split('-').reverse().join('/')}</td>
                    <td>${d.raceTime}</td>
                    <td>${d.raceName}</td>
                    <td>${d.responsible || '-'}</td>
                    <td>${d.status}</td>
                    <td>R$ ${d.totalValue?.toFixed(2) || '0.00'}</td>
                    <td>
                        <button class="btn-blue btn-edit-hist">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="excluirCorridaHistorico('${docSnap.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tr.querySelector('.btn-edit-hist').onclick = () => window.abrirEdicaoCorrida({id: docSnap.id, ...d});
                tb.appendChild(tr);
            }
        });
        if(!encontrou) tb.innerHTML = '<tr><td colspan="7">Nenhuma corrida encontrada neste per√≠odo.</td></tr>';
    };

    window.excluirCorridaHistorico = async (id) => {
        if(confirm("Tem certeza que deseja apagar permanentemente esta corrida do hist√≥rico?")) {
            await deleteDoc(doc(db, "agendamentos", id));
            carregarHistoricoCorridas();
        }
    };

    window.abrirEdicaoCorrida = (data) => {
        document.getElementById('editRaceId').value = data.id;
        document.getElementById('editRaceName').value = data.raceName;
        document.getElementById('editRaceResp').value = data.responsible || '';
        document.getElementById('editRaceDate').value = data.raceDate;
        document.getElementById('editRaceTime').value = data.raceTime;
        document.getElementById('editRaceStatus').value = data.status;
        document.getElementById('modalEditCorrida').style.display = 'block';
    };

    window.salvarEdicaoCorrida = async () => {
        const id = document.getElementById('editRaceId').value;
        const dados = {
            raceName: document.getElementById('editRaceName').value,
            responsible: document.getElementById('editRaceResp').value,
            raceDate: document.getElementById('editRaceDate').value,
            raceTime: document.getElementById('editRaceTime').value,
            status: document.getElementById('editRaceStatus').value
        };
        await updateDoc(doc(db, "agendamentos", id), dados);
        document.getElementById('modalEditCorrida').style.display = 'none';
        carregarHistoricoCorridas();
        alert("Corrida atualizada com sucesso!");
    };

    window.cadastrarProduto = async () => {
        const nome = document.getElementById('novoProdNome').value;
        const preco = parseFloat(document.getElementById('novoProdPreco').value);
        if(!nome || isNaN(preco)) return alert("Preencha Nome e Pre√ßo");
        await addDoc(collection(db, "produtos"), { nome, preco, estoque: 0, estoqueMin: parseInt(document.getElementById('novoProdMin').value) || 0 });
        alert("Produto cadastrado!");
    };

    window.carregarProdutos = () => {
        onSnapshot(collection(db, "produtos"), (snap) => {
            const listEstoque = document.getElementById('listaEstoqueGeralBody');
            const selectVenda = document.getElementById('selectProdutoVenda');
            const selectEntrada = document.getElementById('selectEntradaProduto'); 
            listEstoque.innerHTML = ""; selectVenda.innerHTML = "";
            if(selectEntrada) selectEntrada.innerHTML = "<option value=''>Selecione o produto...</option>"; 
            snap.forEach(d => {
                const p = d.data();
                listEstoque.innerHTML += `<tr><td>${p.nome}</td><td>R$ ${p.preco.toFixed(2)}</td><td>${p.estoque}</td><td>${p.estoqueMin}</td><td>${p.estoque <= p.estoqueMin ? '‚ö†Ô∏è' : '‚úÖ'}</td><td><button class="btn-danger" onclick="deletarProduto('${d.id}')">X</button></td></tr>`;
                selectVenda.innerHTML += `<option value='${JSON.stringify({id: d.id, ...p})}'>${p.nome}</option>`;
                if(selectEntrada) selectEntrada.innerHTML += `<option value='${d.id}'>${p.nome}</option>`;
            });
        });
        onSnapshot(query(collection(db, "vendas_avulsas"), orderBy("createdAt", "desc")), (snap) => {
            const tb = document.querySelector('#tabelaVendasAvulsas tbody'); tb.innerHTML = "";
            snap.forEach(d => {
                const v = d.data();
                tb.innerHTML += `<tr><td>${v.dataVenda}</td><td>${v.item}</td><td>${v.quantidade}</td><td>${v.paymentMethod}</td><td>R$ ${v.totalVenda.toFixed(2)}</td><td><button class="btn-danger" onclick="deletarVenda('${d.id}')">X</button></td></tr>`;
            });
        });
    };

    window.registrarEntrada = async () => {
        const id = document.getElementById('selectEntradaProduto').value;
        const qtd = parseInt(document.getElementById('entradaQtd').value);
        const custo = parseFloat(document.getElementById('entradaCusto').value);
        if(!id || !qtd || isNaN(custo)) return alert("Selecione o produto, quantidade e custo.");
        await updateDoc(doc(db, "produtos", id), { estoque: increment(qtd) });
        await addDoc(collection(db, "despesas"), { descricao: `Compra Estoque ID: ${id}`, categoria: 'CompraEstoque', valor: custo * qtd, dataDespesa: new Date().toISOString().split('T')[0], createdAt: Timestamp.now() });
        alert("Entrada registrada!");
    };

    window.realizarVendaAvulsa = async () => {
        const prod = JSON.parse(document.getElementById('selectProdutoVenda').value);
        const qtd = parseInt(document.getElementById('qtdProdutoVenda').value);
        const total = prod.preco * qtd;
        await addDoc(collection(db, "vendas_avulsas"), { item: prod.nome, quantidade: qtd, totalVenda: total, paymentMethod: document.getElementById('salePayment').value, dataVenda: new Date().toISOString().split('T')[0], createdAt: Timestamp.now() });
        await updateDoc(doc(db, "produtos", prod.id), { estoque: increment(-qtd) });
        alert("Venda realizada!");
    };

    window.salvarDespesa = async () => {
        const valor = parseFloat(document.getElementById('gastoValor').value);
        if(!valor) return alert("Informe o valor");
        await addDoc(collection(db, "despesas"), { descricao: document.getElementById('gastoDescricao').value, categoria: document.getElementById('gastoCategoria').value, valor: valor, dataDespesa: document.getElementById('gastoData').value, createdAt: Timestamp.now() });
        alert("Despesa registrada!");
    };

    function carregarDespesas() {
        onSnapshot(query(collection(db, "despesas"), orderBy("dataDespesa", "desc")), (snap) => {
            const tb = document.querySelector('#tabelaDespesas tbody'); tb.innerHTML = "";
            snap.forEach(d => {
                const g = d.data();
                tb.innerHTML += `<tr><td>${g.dataDespesa}</td><td>${g.descricao}</td><td>R$ ${g.valor.toFixed(2)}</td><td><button class="btn-danger" onclick="deletarDespesa('${d.id}')">X</button></td></tr>`;
            });
        });
    }

    /* --- L√ìGICA DE APORTES (NOVO) --- */
    window.salvarAporte = async () => {
        const desc = document.getElementById('aporteDescricao').value;
        const val = parseFloat(document.getElementById('aporteValor').value);
        const data = document.getElementById('aporteData').value;
        if(!desc || !val || !data) return alert("Preencha todos os campos!");
        await addDoc(collection(db, "aportes"), {
            descricao: desc,
            valor: val,
            dataAporte: data,
            createdAt: Timestamp.now()
        });
        document.getElementById('aporteDescricao').value = "";
        document.getElementById('aporteValor').value = "";
        alert("Aporte Registrado!");
    };

    function carregarAportes() {
        onSnapshot(query(collection(db, "aportes"), orderBy("dataAporte", "desc")), (snap) => {
            const tb = document.querySelector('#tabelaAportes tbody');
            tb.innerHTML = "";
            snap.forEach(d => {
                const a = d.data();
                tb.innerHTML += `<tr><td>${a.dataAporte.split('-').reverse().join('/')}</td><td>${a.descricao}</td><td style="color:var(--secondary); font-weight:bold;">R$ ${a.valor.toFixed(2)}</td><td><button class="btn-danger" onclick="deletarAporte('${d.id}')">X</button></td></tr>`;
            });
        });
    }

    /* RELAT√ìRIO ATUALIZADO PARA PAGAMENTO MISTO */
    window.gerarRelatorio = async () => {
        const start = document.getElementById('reportStart').value;
        const end = document.getElementById('reportEnd').value;
        const tb = document.querySelector('#tabelaRelatorioCompleto tbody'); tb.innerHTML = "";
        let tot = 0, din = 0, px = 0, deb = 0, cre = 0;

        const vSnap = await getDocs(collection(db, "vendas_avulsas"));
        vSnap.forEach(d => {
            const v = d.data();
            if((!start || v.dataVenda >= start) && (!end || v.dataVenda <= end)) {
                tot += v.totalVenda;
                if(v.paymentMethod === 'Dinheiro') din += v.totalVenda;
                else if(v.paymentMethod === 'PIX') px += v.totalVenda;
                else if(v.paymentMethod === 'D√©bito') deb += v.totalVenda;
                else if(v.paymentMethod === 'Cr√©dito') cre += v.totalVenda;
                tb.innerHTML += `<tr><td>${v.dataVenda}</td><td>Venda</td><td>${v.item}</td><td>${v.paymentMethod}</td><td>R$ ${v.totalVenda.toFixed(2)}</td></tr>`;
            }
        });

        const cSnap = await getDocs(collection(db, "agendamentos"));
        cSnap.forEach(d => {
            const c = d.data();
            
            // Se for multi-stage e o valor total for 0, ignora esta etapa no relat√≥rio para evitar duplicidade
            if (c.isMultiStage && c.totalValue === 0) return;

            if((!start || c.raceDate >= start) && (!end || c.raceDate <= end)) {
                c.drivers.forEach(dr => {
                    tot += dr.price;
                    
                    // L√≥gica para Pagamento Misto
                    if(dr.paymentMethod === 'Misto' && dr.splitPayments) {
                        dr.splitPayments.forEach(sp => {
                            if(sp.method === 'Dinheiro') din += sp.value;
                            else if(sp.method === 'PIX') px += sp.value;
                            else if(sp.method === 'D√©bito') deb += sp.value;
                            else if(sp.method === 'Cr√©dito') cre += sp.value;
                        });
                        // Na tabela mostra resumo
                        tb.innerHTML += `<tr><td>${c.raceDate}</td><td>Corrida</td><td>${dr.name}</td><td>Misto</td><td>R$ ${dr.price.toFixed(2)}</td></tr>`;
                    } else {
                        // L√≥gica Padr√£o
                        if(dr.paymentMethod === 'Dinheiro') din += dr.price;
                        else if(dr.paymentMethod === 'PIX') px += dr.price;
                        else if(dr.paymentMethod === 'D√©bito') deb += dr.price;
                        else if(dr.paymentMethod === 'Cr√©dito') cre += dr.price;
                        tb.innerHTML += `<tr><td>${c.raceDate}</td><td>Corrida</td><td>${dr.name}</td><td>${dr.paymentMethod}</td><td>R$ ${dr.price.toFixed(2)}</td></tr>`;
                    }
                });
            }
        });

        document.getElementById('statTotal').innerText = `R$ ${tot.toFixed(2)}`;
        document.getElementById('statDinheiro').innerText = `R$ ${din.toFixed(2)}`;
        document.getElementById('statPIX').innerText = `R$ ${px.toFixed(2)}`;
        document.getElementById('statDebito').innerText = `R$ ${deb.toFixed(2)}`;
        document.getElementById('statCredito').innerText = `R$ ${cre.toFixed(2)}`;
    };

    window.atualizarDashboard = async () => {
        const start = document.getElementById('dashStart').value;
        const end = document.getElementById('dashEnd').value;
        let fat = 0, desp = 0, totalAportes = 0; 
        let cats = {};

        // Arrays para a tabela detalhada
        let historyArr = [];

        // 1. DESPESAS - Item por Item (com exclus√£o)
        const dSnap = await getDocs(collection(db, "despesas"));
        dSnap.forEach(d => {
            const g = d.data();
            if((!start || g.dataDespesa >= start) && (!end || g.dataDespesa <= end)) {
                desp += g.valor; 
                cats[g.categoria] = (cats[g.categoria] || 0) + g.valor;
                
                // Adiciona ao hist√≥rico
                historyArr.push({
                    id: d.id,
                    date: g.dataDespesa,
                    desc: g.descricao,
                    type: 'despesa',
                    val: g.valor * -1, // negativo para visualiza√ß√£o
                    cat: g.categoria
                });
            }
        });

        // 2. APORTES - Item por Item (com exclus√£o)
        const aSnap = await getDocs(collection(db, "aportes"));
        aSnap.forEach(d => {
            const a = d.data();
            if((!start || a.dataAporte >= start) && (!end || a.dataAporte <= end)) {
                totalAportes += a.valor;
                
                historyArr.push({
                    id: d.id,
                    date: a.dataAporte,
                    desc: `Aporte: ${a.descricao}`,
                    type: 'aporte',
                    val: a.valor,
                    cat: 'Investimento'
                });
            }
        });

        // 3. VENDAS - Agrupadas por dia (Unificar)
        const vSnap = await getDocs(collection(db, "vendas_avulsas"));
        let salesByDay = {};
        vSnap.forEach(d => { 
            const v = d.data(); 
            if((!start || v.dataVenda >= start) && (!end || v.dataVenda <= end)) {
                fat += v.totalVenda; 
                salesByDay[v.dataVenda] = (salesByDay[v.dataVenda] || 0) + v.totalVenda;
            }
        });
        // Converter agrupamento em linhas do hist√≥rico
        for (const [date, total] of Object.entries(salesByDay)) {
            historyArr.push({
                id: null, // Sem ID espec√≠fico pois √© agrupado
                date: date,
                desc: `Vendas do Dia (${date.split('-').reverse().join('/')})`,
                type: 'venda_group',
                val: total,
                cat: 'Entrada'
            });
        }
        
        // 4. CORRIDAS - Agrupadas por dia (Unificar)
        const cSnap = await getDocs(collection(db, "agendamentos"));
        let racesByDay = {};
        cSnap.forEach(d => { 
            const c = d.data(); 
            if((!start || c.raceDate >= start) && (!end || c.raceDate <= end)) {
                fat += c.totalValue; 
                racesByDay[c.raceDate] = (racesByDay[c.raceDate] || 0) + c.totalValue;
            }
        });
        // Converter agrupamento em linhas do hist√≥rico
        for (const [date, total] of Object.entries(racesByDay)) {
            historyArr.push({
                id: null,
                date: date,
                desc: `Baterias do Dia (${date.split('-').reverse().join('/')})`,
                type: 'corrida_group',
                val: total,
                cat: 'Entrada'
            });
        }

        // --- Renderiza√ß√£o dos Totais e Gr√°ficos ---
        document.getElementById('dashFatBruto').innerText = `R$ ${fat.toFixed(2)}`;
        document.getElementById('dashDespesas').innerText = `R$ ${desp.toFixed(2)}`;
        document.getElementById('dashAportes').innerText = `R$ ${totalAportes.toFixed(2)}`;
        
        const saldoFinal = (fat - desp) + totalAportes;
        document.getElementById('dashSaldo').innerText = `R$ ${saldoFinal.toFixed(2)}`;

        const ctxFluxo = document.getElementById('chartFluxo').getContext('2d');
        if(chartFluxoInstancia) chartFluxoInstancia.destroy();
        chartFluxoInstancia = new Chart(ctxFluxo, {
            type: 'bar',
            data: { labels: ['Entradas (Vendas)', 'Aportes', 'Sa√≠das'], datasets: [{ data: [fat, totalAportes, desp], backgroundColor: ['#00e676', '#2979ff', '#ff1744'] }] },
            options: { plugins: { legend: { display: false } } }
        });

        const ctxCat = document.getElementById('chartCategorias').getContext('2d');
        if(chartCategoriaInstancia) chartCategoriaInstancia.destroy();
        chartCategoriaInstancia = new Chart(ctxCat, {
            type: 'pie',
            data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#2979ff', '#ffea00', '#ff1744', '#e040fb', '#00e676'] }] }
        });

        // --- Renderiza√ß√£o da Tabela Detalhada ---
        // Ordenar por data (mais recente primeiro)
        historyArr.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        const tbDash = document.querySelector('#tabelaDashDetalhada tbody');
        tbDash.innerHTML = "";

        historyArr.forEach(item => {
            const tr = document.createElement('tr');
            
            // Defini√ß√£o de cor e a√ß√£o
            let color = 'white';
            let actionBtn = '';
            
            if (item.type === 'despesa') {
                color = '#ff1744'; // Vermelho
                actionBtn = `<button class="btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deletarDespesa('${item.id}')">Excluir</button>`;
            } else if (item.type === 'aporte') {
                color = '#2979ff'; // Azul
                actionBtn = `<button class="btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deletarAporte('${item.id}')">Excluir</button>`;
            } else {
                // Grupos (Vendas/Baterias)
                color = '#00e676'; // Verde
                // N√£o adicionamos bot√£o de exclus√£o em grupos unificados para evitar erro de integridade
                actionBtn = `<span style="font-size:0.8rem; color:#888;">Agrupado</span>`;
            }

            tr.innerHTML = `
                <td>${item.date.split('-').reverse().join('/')}</td>
                <td>${item.desc}</td>
                <td>${item.cat}</td>
                <td style="color:${color}; font-weight:bold;">R$ ${item.val.toFixed(2)}</td>
                <td>${actionBtn}</td>
            `;
            tbDash.appendChild(tr);
        });
    }

    async function loadCircuits() {
        const snap = await getDocs(collection(db, "circuits"));
        const sel = document.getElementById('circuitSelect'); sel.innerHTML = "";
        snap.forEach(d => { sel.innerHTML += `<option value='${JSON.stringify({id: d.id, ...d.data()})}'>${d.data().name}</option>`; });
    }

    window.onload = () => { 
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('raceDate').value = hoje;
        document.getElementById('reportStart').value = hoje;
        document.getElementById('reportEnd').value = hoje;
        document.getElementById('dashStart').value = hoje;
        document.getElementById('dashEnd').value = hoje;
        document.getElementById('histStart').value = hoje;
        document.getElementById('histEnd').value = hoje;
        document.getElementById('gastoData').value = hoje;
        document.getElementById('aporteData').value = hoje; 
        
        carregarClientes(); loadCircuits(); loadBookings(); carregarProdutos(); carregarDespesas(); loadRaceModes(); carregarAportes();
    };
</script>
</body>
</html>
